# Logrotate configuration for Squid proxy
# Enhanced log management for Life in Hand Development Environment
# ==============================================================

/var/log/squid/*.log {
    # Rotate logs daily
    daily
    
    # Keep 30 days of logs
    rotate 30
    
    # Compress old logs to save space
    compress
    delaycompress
    
    # Don't rotate if empty
    notifempty
    
    # Create new log files with correct permissions
    create 640 proxy proxy
    
    # Use shared scripts for all squid logs
    sharedscripts
    
    # Post-rotation script to reload Squid
    postrotate
        # Send HUP signal to Squid to reopen log files
        if [ -f /var/run/squid.pid ]; then
            kill -HUP $(cat /var/run/squid.pid) 2>/dev/null || true
        fi
        
        # Alternative method if PID file doesn't exist
        if pgrep -x squid > /dev/null; then
            squid -k rotate 2>/dev/null || true
        fi
    endscript
    
    # Error handling
    missingok
    
    # Copy and truncate instead of moving
    copytruncate
}

# Specific configuration for access logs (more frequent rotation)
/var/log/squid/access.log {
    daily
    rotate 60
    compress
    delaycompress
    notifempty
    create 640 proxy proxy
    postrotate
        if pgrep -x squid > /dev/null; then
            squid -k rotate 2>/dev/null || true
        fi
    endscript
    missingok
    copytruncate
    
    # Size-based rotation for access logs (they grow faster)
    size 100M
}

# Cache log rotation (less frequent, smaller files)
/var/log/squid/cache.log {
    weekly
    rotate 12
    compress
    delaycompress
    notifempty
    create 640 proxy proxy
    postrotate
        if pgrep -x squid > /dev/null; then
            squid -k rotate 2>/dev/null || true
        fi
    endscript
    missingok
    copytruncate
}

# Domain management log
/var/log/squid/domain-management.log {
    weekly
    rotate 12
    compress
    delaycompress
    notifempty
    create 640 proxy proxy
    missingok
    copytruncate
    size 10M
}