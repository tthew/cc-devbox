# Squid Proxy Configuration for Life in Hand Development Environment
# Simplified configuration without SSL bump (OpenSSL not available)
# =======================================================================

# Basic Configuration
# ==================
http_port 3128 transparent
http_port 8080

# Access Control Lists (ACLs)
# ===========================

# Safe ports
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# Connection methods
acl CONNECT method CONNECT

# Local networks
acl localhost src 127.0.0.1/32 ::1
acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1

# Docker networks
acl docker_networks src 172.16.0.0/12 192.168.0.0/16 10.0.0.0/8

# Development ports
acl dev_ports port 3000 3001 4000 5000 8000 8080 9000

# Import domain whitelists
include /etc/squid/domains-squid.conf

# Access Rules
# ============

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost and docker networks
http_access allow localhost
http_access allow docker_networks

# Allow access to whitelisted domains for HTTP
http_access allow whitelisted_domains

# Allow CONNECT to whitelisted SSL domains
http_access allow CONNECT whitelisted_ssl_domains

# Allow CONNECT to development ports
http_access allow CONNECT dev_ports

# Deny all other access
http_access deny all

# Caching Configuration
# ====================
cache_dir ufs /var/cache/squid 500 16 256
cache_mem 128 MB
maximum_object_size_in_memory 8 KB
maximum_object_size 256 MB

# Cache replacement policy
cache_replacement_policy heap LFUDA
memory_replacement_policy heap GDSF

# Refresh patterns
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Logging Configuration
# ====================
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log none

# Performance Tuning
# ==================
dns_nameservers 127.0.0.1 8.8.8.8 8.8.4.4
positive_dns_ttl 6 hours
negative_dns_ttl 1 minute

# Request timeout settings
request_timeout 30 seconds
connect_timeout 10 seconds
peer_connect_timeout 10 seconds

# HTTP options
http_reply_access allow all
icp_access deny all
htcp_access deny all

# Miscellaneous
# =============
coredump_dir /var/cache/squid
pid_filename /var/run/squid.pid

# Forwarding
forwarded_for delete
via off