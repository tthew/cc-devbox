# Squid Proxy Configuration for Life in Hand Development Environment
# Simplified configuration without SSL bump (OpenSSL not available)
# =======================================================================

# Basic Configuration
# ==================  
http_port 3128
http_port 8080

# Safe ports
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# Connection methods
acl CONNECT method CONNECT

# Local networks  
acl localnet src 127.0.0.0/8
acl localnet src ::1

# Docker networks
acl docker_networks src 172.16.0.0/12 192.168.0.0/16 10.0.0.0/8

# Development ports
acl dev_ports port 3000 3001 54321 54322 54323 54324

# Load domain-specific ACLs from external file
include /etc/squid/domains-squid.conf

# Access Rules
# ============

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from local networks
http_access allow localnet manager
http_access deny manager

# Allow access to whitelisted domains only (DESTINATION FILTERING)
http_access allow localnet whitelisted_domains

# Allow HTTPS access to whitelisted domains  
http_access allow localnet CONNECT whitelisted_ssl_domains

# Allow Docker networks to whitelisted domains only
http_access allow docker_networks whitelisted_domains
http_access allow docker_networks CONNECT whitelisted_ssl_domains

# Allow access to development ports from local networks
http_access allow localnet dev_ports

# Deny all other access
http_access deny all

# Remove duplicate http_port directive
# http_port 3128

# Performance and Caching
# =======================

# Cache configuration
cache_mem 256 MB
maximum_object_size_in_memory 8 KB
cache_replacement_policy lru
memory_replacement_policy lru

# Cache directory
cache_dir ufs /var/cache/squid 1000 16 256

# Cache access log
cache_access_log stdio:/var/log/squid/access.log squid

# Cache log
cache_log /var/log/squid/cache.log

# Store log
cache_store_log none

# Maximum object size
maximum_object_size 100 MB

# Cache rules for better performance
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Connection pooling for better performance (removed unsupported directive)
client_persistent_connections on
server_persistent_connections on

# DNS Configuration
# =================

# DNS servers
dns_nameservers 8.8.8.8 8.8.4.4

# DNS cache
positive_dns_ttl 6 hours
negative_dns_ttl 1 minute

# Logging Configuration
# ====================

# Log format with comprehensive information (using built-in combined format)
# logformat combined %>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh

# Access log (using built-in combined format)
access_log /var/log/squid/access.log combined

# Debug logging (can be adjusted)
debug_options ALL,1 33,2

# Log rotation
logfile_rotate 10

# Security Configuration
# ======================

# Forwarded headers
forwarded_for delete

# Hide squid version
httpd_suppress_version_string on

# Request header access
request_header_access Server deny all
request_header_access User-Agent allow all
request_header_access Accept allow all
request_header_access Accept-Language allow all
request_header_access Accept-Encoding allow all
request_header_access Connection allow all
request_header_access Content-Type allow all
request_header_access Content-Length allow all
request_header_access Host allow all

# Reply header access
reply_header_access Server deny all
reply_header_access X-Powered-By deny all

# Administrative Configuration
# ============================

# Administrator email
cache_mgr admin@localhost

# Hostname
visible_hostname claude-dev-proxy

# Shutdown timeout
shutdown_lifetime 30 seconds

# Error pages
error_directory /usr/share/squid/errors/English

# Process Configuration
# =====================

# Process management
workers 1
cpu_affinity_map process_numbers=1 cores=1

# Memory limits
memory_pools on
memory_pools_limit 64 MB

# File descriptor limits
max_filedescriptors 4096

# Connection limits (removed unsupported directive)
# http_access_log_buff_size 64 KB

# Timeout Configuration
# ====================

# Client timeouts
client_lifetime 1 day
client_idle_pconn_timeout 120 seconds

# Server timeouts
request_timeout 5 minutes
persistent_request_timeout 2 minutes

# Connect timeout
connect_timeout 2 minutes

# Read timeout
read_timeout 15 minutes

# Write timeout
write_timeout 15 minutes

# Miscellaneous Configuration
# ==========================

# Coredump directory
coredump_dir /var/cache/squid

# Strip query terms from logged URLs
strip_query_terms off

# Follow X-Forwarded-For header
follow_x_forwarded_for allow localnet
follow_x_forwarded_for deny all

# Buffering
request_body_max_size 100 MB

# Range handling
range_offset_limit -1

# Quick abort configuration
quick_abort_min 0
quick_abort_max 0
quick_abort_pct 100

# Store URL rewrite (removed unsupported directive)
# store_id_rewrite_program none

# HTTP compliance
relaxed_header_parser on

# Pipeline prefetch (set to 1 as recommended)
pipeline_prefetch 1

# Half-closed connections
half_closed_clients off

# Offline mode
offline_mode off

# Vary headers
vary_ignore_expire on

# Reload configuration
reload_into_ims on